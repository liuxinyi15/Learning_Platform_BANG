{% extends "base.html" %}
{% block title %}Material Library{% endblock %}

{% block head %}
<style>
    /* ä¾§è¾¹æ æ¿€æ´»æ ·å¼ (Amber Theme) */
    .category-item.active {
        background-color: #fffbeb; /* amber-50 */
        color: #b45309; /* amber-700 */
        border-right: 3px solid #f59e0b; /* amber-500 */
        font-weight: 700;
    }
    
    /* èµ„æºå¡ç‰‡æ‚¬æµ®ç‰¹æ•ˆ */
    .book-card { 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .book-card:hover { 
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 20px; }
</style>
{% endblock %}

{% block content %}
{% raw %}
<div id="app" v-cloak class="max-w-[1400px] mx-auto p-6 fade-in-up">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4 border-b border-slate-100 pb-6">
        <div class="flex items-center gap-4">
            <div class="inline-flex items-center justify-center w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl text-3xl shadow-sm border border-amber-100">
                ğŸ“š
            </div>
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">Material Library</h1>
                <p class="text-slate-500 text-sm font-medium">Centralized Resource Management</p>
            </div>
        </div>

        <div class="bg-slate-100 p-1 rounded-xl flex gap-1">
            <button @click="currentSource = 'official'" 
                :class="currentSource === 'official' ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'"
                class="px-6 py-2 rounded-lg text-sm font-bold transition-all">
                ğŸ›ï¸ Official
            </button>
            <button @click="currentSource = 'user'" 
                :class="currentSource === 'user' ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'"
                class="px-6 py-2 rounded-lg text-sm font-bold transition-all">
                â˜ï¸ My Uploads
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sticky top-24">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 px-2">
                    ğŸ“‚ Libraries
                </h3>
                
                <div class="space-y-1 custom-scroll max-h-[70vh] overflow-y-auto">
                    <div @click="currentCategory = 'All'" 
                         class="category-item cursor-pointer px-4 py-3 rounded-lg text-sm font-medium text-slate-600 transition-colors flex justify-between items-center group"
                         :class="{ 'active': currentCategory === 'All' }">
                        <span>All Materials</span>
                        <span class="text-xs bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full group-hover:bg-amber-100 group-hover:text-amber-600 transition">
                            {{ filteredMaterialsBySource.length }}
                        </span>
                    </div>

                    <div v-for="cat in uniqueCategories" :key="cat" 
                         @click="currentCategory = cat"
                         class="category-item cursor-pointer px-4 py-3 rounded-lg text-sm font-medium text-slate-600 transition-colors flex justify-between items-center group"
                         :class="{ 'active': currentCategory === cat }">
                        <span class="truncate">{{ cat }}</span>
                        <span v-if="currentCategory === cat" class="text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">
                            {{ filteredMaterials.length }}
                        </span>
                    </div>
                </div>

                <div v-if="currentSource === 'user'" class="mt-6 pt-6 border-t border-slate-100">
                    <button @click="showUploadModal = true" class="w-full py-3 bg-amber-50 text-amber-700 font-bold rounded-xl hover:bg-amber-100 transition flex items-center justify-center gap-2 border border-amber-200 border-dashed">
                        <span>+</span> Upload New
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-10">
            
            <div class="flex justify-between items-center mb-6">
                <div class="text-sm font-bold text-slate-700">
                    <span class="text-amber-600 mr-2">path:</span>
                    Library / {{ currentSource === 'official' ? 'Official' : 'User' }} / {{ currentCategory }}
                </div>
                
                <div class="flex gap-3">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                        <input v-model="searchQuery" type="text" placeholder="Search files..." 
                               class="pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm outline-none focus:border-amber-400 transition w-48">
                    </div>
                    <select v-model="sortBy" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm outline-none cursor-pointer text-slate-600">
                        <option value="newest">ğŸ•’ Newest</option>
                        <option value="oldest">ğŸ“… Oldest</option>
                        <option value="a-z">ğŸ”¤ Name A-Z</option>
                    </select>
                </div>
            </div>

            <div v-if="filteredMaterials.length === 0" class="text-center py-32 bg-white rounded-3xl border border-dashed border-slate-200">
                <div class="text-4xl mb-3 opacity-50">ğŸ‚</div>
                <p class="text-slate-400 font-medium">No materials found in this category.</p>
            </div>

            <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <div v-for="m in filteredMaterials" :key="m.id" class="book-card bg-white rounded-2xl border border-slate-100 overflow-hidden flex flex-col h-full relative group">
                    
                    <a v-if="currentSource === 'user'" :href="'/library/delete/' + m.id" 
                       onclick="return confirm('Delete this file?')"
                       class="absolute top-2 right-2 w-8 h-8 bg-white/90 backdrop-blur rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center font-bold shadow-sm opacity-0 group-hover:opacity-100 transition-all z-20 cursor-pointer">
                        Ã—
                    </a>

                    <div class="h-40 bg-slate-50 flex items-center justify-center text-5xl relative overflow-hidden group-hover:brightness-95 transition">
                        <img v-if="m.cover_path" :src="'/library/cover/' + m.id" class="w-full h-full object-cover">
                        <span v-else class="opacity-50">ğŸ“„</span>
                        
                        <a :href="'/library/download/' + m.id" class="absolute inset-0 bg-amber-900/0 group-hover:bg-amber-900/10 flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 text-none">
                            <span class="bg-white text-amber-700 px-4 py-2 rounded-full font-bold text-xs shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                                Download
                            </span>
                        </a>
                    </div>

                    <div class="p-4 flex-1 flex flex-col">
                        <div class="mb-2">
                            <span :class="getCategoryColor(m.category)" 
                                  class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider inline-block">
                                {{ m.category }}
                            </span>
                        </div>
                        
                        <h4 class="font-bold text-slate-700 text-sm mb-1 leading-snug line-clamp-2" :title="m.filename">
                            {{ m.filename }}
                        </h4>
                        
                        <div class="mt-auto pt-3 flex justify-between items-center text-[10px] text-slate-400 font-medium">
                            <span>{{ formatDate(m.upload_time) }}</span>
                            <span>{{ getFileExt(m.filename) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showUploadModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-8 max-w-lg w-full shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-slate-800">Upload to Library</h3>
                <button @click="showUploadModal = false" class="text-slate-400 hover:text-slate-600 text-2xl">Ã—</button>
            </div>
            
            <form method="POST" enctype="multipart/form-data" action="/library">
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Files</label>
                        <input type="file" name="material_file" multiple required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-amber-400">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Category</label>
                        <div class="flex gap-2">
                            <select name="category_select" class="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-amber-400">
                                <option v-for="cat in allCategories" :value="cat">{{ cat }}</option>
                            </select>
                            <input type="text" name="category_new" placeholder="Or New..." class="w-1/3 p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-amber-400">
                        </div>
                        <input type="hidden" name="category_mode" value="select"> 
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Cover (Optional)</label>
                        <input type="file" name="cover_file" accept="image/*" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-amber-400">
                    </div>

                    <button type="submit" class="w-full py-3.5 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl shadow-lg shadow-amber-200 transition transform active:scale-95">
                        Start Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endraw %}

<script>
    const serverOfficial = {{ official_materials|tojson }};
    const serverUser = {{ user_materials|tojson }};
    const serverCategories = {{ categories|tojson }};
</script>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const currentSource = ref('official'); // 'official' or 'user'
            const currentCategory = ref('All');
            const sortBy = ref('newest');
            const searchQuery = ref('');
            const showUploadModal = ref(false);

            const allCategories = ref(serverCategories);

            // é¢œè‰²æ˜ å°„æ±  (ç³–æœè‰²ç³»)
            const colorMap = [
                'bg-rose-100 text-rose-700',
                'bg-blue-100 text-blue-700', 
                'bg-emerald-100 text-emerald-700',
                'bg-purple-100 text-purple-700',
                'bg-orange-100 text-orange-700',
                'bg-indigo-100 text-indigo-700',
                'bg-cyan-100 text-cyan-700',
                'bg-lime-100 text-lime-700'
            ];

            // æ ¹æ®åˆ†ç±»åç”Ÿæˆå›ºå®šé¢œè‰²
            const getCategoryColor = (catName) => {
                let hash = 0;
                for (let i = 0; i < catName.length; i++) {
                    hash = catName.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash) % colorMap.length;
                return colorMap[index];
            };

            // 1. å…ˆæ ¹æ® Source (Tabs) è¿‡æ»¤
            const materialsBySource = computed(() => {
                return currentSource.value === 'official' ? serverOfficial : serverUser;
            });

            // 2. è·å–å½“å‰ Source ä¸‹çš„æ‰€æœ‰åˆ†ç±»ï¼ˆç”¨äºä¾§è¾¹æ ï¼‰
            const uniqueCategories = computed(() => {
                const cats = new Set(materialsBySource.value.map(m => m.category));
                return Array.from(cats).sort();
            });

            // 3. æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼šSource -> Category -> Search -> Sort
            const filteredMaterials = computed(() => {
                let list = materialsBySource.value;

                // Category Filter
                if (currentCategory.value !== 'All') {
                    list = list.filter(m => m.category === currentCategory.value);
                }

                // Search Filter
                if (searchQuery.value) {
                    const q = searchQuery.value.toLowerCase();
                    list = list.filter(m => m.filename.toLowerCase().includes(q));
                }

                // Sorting
                return list.sort((a, b) => {
                    if (sortBy.value === 'newest') return new Date(b.upload_time) - new Date(a.upload_time);
                    if (sortBy.value === 'oldest') return new Date(a.upload_time) - new Date(b.upload_time);
                    if (sortBy.value === 'a-z') return a.filename.localeCompare(b.filename);
                    return 0;
                });
            });

            // è¾…åŠ©ï¼šè·å–æ–‡ä»¶åç¼€
            const getFileExt = (filename) => {
                return filename.split('.').pop().toUpperCase();
            };

            // è¾…åŠ©ï¼šæ ¼å¼åŒ–æ—¥æœŸ
            const formatDate = (dateStr) => {
                if(!dateStr) return '';
                return dateStr.substring(0, 10);
            };

            return {
                currentSource, currentCategory, sortBy, searchQuery, showUploadModal,
                allCategories, uniqueCategories,
                filteredMaterialsBySource: materialsBySource, // ç”¨äºæ˜¾ç¤º Total Count
                filteredMaterials,
                getCategoryColor, getFileExt, formatDate
            };
        }
    }).mount('#app');
</script>
{% endblock %}