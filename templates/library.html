{% extends "base.html" %}

{% block title %}ç´ æèµ„æ–™åº“{% endblock %}

{% block head %}
<style>
    /* èµ„æ–™åº“ç‰¹æœ‰æ ·å¼ (ä¿ç•™ä½ ä¹‹å‰çš„ CSSï¼Œä½†å»æ‰äº† body å’Œ nav-bar çš„éƒ¨åˆ†) */
    .controls-card {
        background: white; padding: 15px 25px; border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between;
        align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;
    }
    .tabs { display: flex; background: #f1f3f5; padding: 5px; border-radius: 10px; }
    .tab-btn {
        padding: 10px 25px; border: none; background: transparent; cursor: pointer;
        border-radius: 8px; font-weight: 600; text-decoration: none; color: #666; transition: all 0.3s;
    }
    .tab-btn:hover { color: #333; background: rgba(255,255,255,0.5); }
    .tab-btn.active { background: white; color: #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    .upload-card {
        background: white; padding: 30px; border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 40px; border: 1px dashed #ced4da;
    }
    /* ...å…¶ä½™æ ·å¼ä¿æŒå…¼å®¹... */
    .bookshelf { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; padding-bottom: 40px; }
    .book-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.3s; display: flex; flex-direction: column; position: relative; }
    .book-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
    .book-cover { height: 150px; background-color: #e9ecef; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .book-tag { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; align-self: flex-start; margin-bottom: 8px; }
    .book-title { font-weight: 700; margin-bottom: 6px; font-size: 16px; color: #333; }
    .book-meta { font-size: 12px; color: #999; margin-bottom: 15px; }
    .delete-btn { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.95); color: #dc3545; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; text-decoration: none; }
    .delete-btn:hover { background: #dc3545; color: white; }
    .download-link { text-decoration: none; color: #007bff; font-weight: bold; font-size: 14px; margin-top: auto; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-[1200px] mx-auto p-6">
    <h1 class="text-3xl font-black text-slate-700 text-center mb-8">ğŸ“š è¯­è¨€å­¦ä¹ èµ„æ–™åº“</h1>

    {% if error %} <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded">{{ error }}</div> {% endif %}
    {% if success %} <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded">{{ success }}</div> {% endif %}

    <div class="controls-card">
        <div class="tabs">
            <a href="/library?tab=official&sort={{ sort_option }}" class="tab-btn {% if active_tab == 'official' %}active{% endif %}">ğŸ›ï¸ å®˜æ–¹æ¨è</a>
            <a href="/library?tab=user&sort={{ sort_option }}" class="tab-btn {% if active_tab == 'user' %}active{% endif %}">â˜ï¸ æˆ‘çš„ä¸Šä¼ </a>
        </div>
        <form action="/library" method="GET" class="flex items-center gap-2">
            <input type="hidden" name="tab" value="{{ active_tab }}">
            <span class="text-sm font-bold text-slate-500">æ’åº:</span>
            <select name="sort" onchange="this.form.submit()" class="p-2 border rounded-lg bg-white text-sm">
                <option value="newest" {% if sort_option == 'newest' %}selected{% endif %}>ğŸ•’ æœ€æ–°ä¸Šä¼ </option>
                <option value="oldest" {% if sort_option == 'oldest' %}selected{% endif %}>ğŸ“… æœ€æ—©ä¸Šä¼ </option>
                <option value="a-z" {% if sort_option == 'a-z' %}selected{% endif %}>ğŸ”¤ åç§° A-Z</option>
            </select>
        </form>
    </div>

    <div class="{% if active_tab != 'official' %}hidden{% endif %}">
        {% if official_materials|length == 0 %}
            <div class="text-center py-20 text-slate-400">æš‚æ— å®˜æ–¹ç´ æ</div>
        {% else %}
            <div class="bookshelf">
                {% for m in official_materials %}
                <div class="book-card">
                    <div class="book-cover">
                        {% if m.cover_path %} <img src="/library/cover/{{ m.id }}"> {% else %} <span style="font-size:40px; opacity:0.3;">ğŸ“–</span> {% endif %}
                    </div>
                    <div class="book-info">
                        <span class="book-tag">{{ m.category }}</span>
                        <div class="book-title">{{ m.filename }}</div>
                        <div class="book-meta">ğŸ“… {{ m.upload_time[:10] }}</div>
                        <a href="/library/download/{{ m.id }}" class="download-link">â¬‡ï¸ ç‚¹å‡»ä¸‹è½½</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div class="{% if active_tab != 'user' %}hidden{% endif %}">
        <div class="upload-card">
            <h3 class="text-lg font-bold text-slate-600 mb-4">â¬†ï¸ ä¸Šä¼ æ–°ç´ æ</h3>
            <form method="POST" enctype="multipart/form-data" class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ–‡ä»¶</label>
                    <input type="file" name="material_file" class="w-full p-2 bg-slate-50 border rounded" required>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-bold text-slate-500 mb-1">å°é¢ (å¯é€‰)</label>
                    <input type="file" name="cover_file" accept="image/*" class="w-full p-2 bg-slate-50 border rounded">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-bold text-slate-500 mb-1">åˆ†ç±»</label>
                    <div class="flex gap-2">
                        <select name="category_select" class="p-2 border rounded bg-white flex-1">
                            {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                        </select>
                        <input type="text" name="category_new" placeholder="æ–°å»º" class="p-2 border rounded w-24">
                    </div>
                </div>
                <button type="submit" class="bg-green-600 text-white px-6 py-2.5 rounded font-bold hover:bg-green-700 transition">ä¸Šä¼ </button>
            </form>
        </div>

        <div class="bookshelf">
            {% for m in user_materials %}
            <div class="book-card">
                <a href="/library/delete/{{ m.id }}" class="delete-btn" onclick="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ');">Ã—</a>
                <div class="book-cover">
                    {% if m.cover_path %} <img src="/library/cover/{{ m.id }}"> {% else %} <span style="font-size:40px; opacity:0.3;">â˜ï¸</span> {% endif %}
                </div>
                <div class="book-info">
                    <span class="book-tag">{{ m.category }}</span>
                    <div class="book-title">{{ m.filename }}</div>
                    <div class="book-meta">ğŸ“… {{ m.upload_time[:10] }}</div>
                    <a href="/library/download/{{ m.id }}" class="download-link">â¬‡ï¸ ç‚¹å‡»ä¸‹è½½</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}