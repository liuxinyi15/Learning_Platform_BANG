{% extends "base.html" %}

{% block title %}è¯æ±‡ç‰¹è®­è¥{% endblock %}

{% block head %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
</style>
{% endblock %}

{% block content %}
{% raw %}
<div id="app" v-cloak class="max-w-[1200px] mx-auto p-6 fade-in-up">
    
    <header class="text-center mb-10">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-lime-100 text-lime-600 rounded-2xl text-3xl mb-4 shadow-sm">
            ğŸ”¤
        </div>
        <h1 class="text-3xl font-black text-slate-800 tracking-tight">è¯æ±‡ç‰¹è®­è¥</h1>
        <p class="text-slate-400 mt-2 text-sm font-medium">åˆ›å»ºè¯æ±‡è¡¨ã€ç”Ÿæˆé—ªå¡ä¸å¬åŠ›éŸ³é¢‘</p>
    </header>

    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
        <nav class="flex gap-2 overflow-x-auto pb-1 max-w-full">
            <div v-for="(board, index) in boards" :key="board.id" class="relative group flex items-center">
                <button @click="activeBoardIndex = index" 
                    :class="activeBoardIndex === index ? 'bg-lime-500 text-white shadow-md shadow-lime-200 transform -translate-y-0.5' : 'bg-white text-slate-500 hover:bg-slate-50 border border-slate-200'" 
                    class="px-6 py-2.5 font-bold transition-all rounded-xl text-sm whitespace-nowrap">
                    {{ board.name }}
                </button>
                <button v-if="boards.length > 1" @click="deleteBoard(index)" class="absolute -top-2 -right-1 bg-white rounded-full w-5 h-5 flex items-center justify-center shadow-sm text-xs text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition border border-slate-200">Ã—</button>
            </div>
            <button @click="createNewBoard" class="px-4 text-lime-600 font-bold text-xl hover:bg-lime-50 rounded-lg transition">+</button>
        </nav>

        <div class="flex gap-3 flex-shrink-0">
            <button @click="exportToExcel" 
                    class="bg-white text-lime-700 border border-lime-200 px-4 py-2.5 rounded-xl hover:bg-lime-50 font-bold transition shadow-sm hover:shadow-md text-sm">
                ğŸ“¥ å¯¼å‡º Excel
            </button>

            <button @click="viewMode = viewMode === 'table' ? 'flashcard' : 'table'" 
                    class="bg-lime-500 text-white px-5 py-2.5 rounded-xl hover:bg-lime-600 font-bold transition shadow-lg shadow-lime-200 text-sm flex items-center gap-2">
                <span v-if="viewMode === 'table'">ğŸ´ è¿›å…¥èƒŒè¯µ</span>
                <span v-else>ğŸ“‹ è¿”å›åˆ—è¡¨</span>
            </button>
        </div>
    </div>

    <div v-if="viewMode === 'table'" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-3 space-y-6">
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-400 uppercase text-[10px] tracking-widest mb-4">Add New Word</h3>
                <div class="space-y-4">
                    <div v-for="header in currentBoard.headers" :key="header">
                        <input v-model="newTaskData[header]" :placeholder="header" 
                               class="w-full border border-slate-200 p-3 rounded-xl outline-none text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-lime-100 focus:border-lime-400 transition">
                    </div>
                    <button @click="addTask" class="w-full bg-lime-500 text-white py-3 rounded-xl font-bold hover:bg-lime-600 transition text-sm shadow-md">
                        æ·»åŠ å•è¯
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-400 uppercase text-[10px] tracking-widest mb-4">Import</h3>
                <label class="block w-full border-2 border-dashed border-lime-200 p-6 rounded-xl text-center cursor-pointer hover:border-lime-500 hover:bg-lime-50 transition group">
                    <div class="text-2xl mb-2 group-hover:scale-110 transition">ğŸ“‚</div>
                    <span class="text-xs text-lime-700 font-bold block">ä¸Šä¼  Excel / CSV</span>
                    <input type="file" @change="handleFileUpload" accept=".csv, .xlsx, .xls" class="hidden">
                </label>
            </div>

            <div class="bg-gradient-to-br from-lime-500 to-green-600 p-6 rounded-2xl shadow-xl text-white">
                <h3 class="font-bold text-white/80 uppercase text-[10px] tracking-widest mb-4 border-b border-white/20 pb-2">ğŸ§ Generate Audio</h3>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="text-[10px] font-bold uppercase opacity-70 block mb-1">Voice</label>
                        <select v-model="audioConfig.voice" class="w-full bg-black/20 border border-white/10 text-xs rounded-lg p-2 text-white outline-none focus:bg-black/30 cursor-pointer">
                            <option value="zh-CN-XiaoxiaoNeural" class="text-black">ğŸ‘©ğŸ» Female (Xiaoxiao)</option>
                            <option value="zh-CN-YunxiNeural" class="text-black">ğŸ‘¨ğŸ» Male (Yunxi)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold uppercase opacity-70 block mb-1">Speed</label>
                        <select v-model="audioConfig.rate" class="w-full bg-black/20 border border-white/10 text-xs rounded-lg p-2 text-white outline-none focus:bg-black/30 cursor-pointer">
                            <option value="-20%" class="text-black">ğŸ¢ Slow (-20%)</option>
                            <option value="+0%" class="text-black">ğŸ° Normal</option>
                            <option value="+20%" class="text-black">ğŸ Fast (+20%)</option>
                        </select>
                    </div>
                </div>

                <button @click="generateAudio" :disabled="isGenerating" class="w-full bg-white text-lime-700 py-3 rounded-xl font-bold hover:bg-lime-50 transition text-sm shadow-lg flex items-center justify-center gap-2">
                    <span v-if="isGenerating">â³ ç”Ÿæˆä¸­...</span>
                    <span v-else>{{ selectedWordIds.length > 0 ? `â–¶ï¸ ç”Ÿæˆé€‰ä¸­ (${selectedWordIds.length})` : `â–¶ï¸ ç”Ÿæˆå…¨éƒ¨` }}</span>
                </button>
            </div>
        </div>

        <div class="lg:col-span-9">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="h-1.5 bg-gradient-to-r from-lime-300 via-green-400 to-lime-300"></div>

                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 text-[10px] uppercase font-bold">
                        <tr>
                            <th class="p-4 w-12 text-center"><input type="checkbox" v-model="isAllSelected" class="accent-lime-600 w-4 h-4"></th>
                            <th v-for="header in currentBoard.headers" :key="header" class="p-4 cursor-pointer hover:text-lime-600">{{ header }}</th>
                            <th class="p-4 text-center">Del</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-for="task in activeTasks" :key="task.id" class="hover:bg-lime-50/30 transition group" :class="selectedWordIds.includes(task.id) ? 'bg-lime-50/50' : ''">
                            <td class="p-4 text-center"><input type="checkbox" :value="task.id" v-model="selectedWordIds" class="accent-lime-600 w-4 h-4"></td>
                            <td v-for="header in currentBoard.headers" :key="header" class="p-4 text-sm text-slate-700" contenteditable="true" @blur="updateCellValue(task, header, $event)">
                                {{ task.data[header] }}
                            </td>
                            <td class="p-4 text-center"><button @click="deletePermanent(task.id)" class="text-slate-300 hover:text-red-500 transition">Ã—</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endraw %}
<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;
    const STORAGE_KEY = 'VOCAB_MASTER_V3';
    // JS é€»è¾‘ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´
    const parseCSVLine = (text) => { const result = []; let cell = ''; let inQuotes = false; for (let i = 0; i < text.length; i++) { let char = text[i]; if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; } else cell += char; } result.push(cell.trim()); return result.map(v => v.replace(/^"|"$/g, '')); };
    createApp({
        setup() {
            const defaultHeaders = ['English', 'Chinese', 'Frequency'];
            const boards = ref([{ id: 1, name: 'Unit 1 Vocab', headers: [...defaultHeaders], tasks: [], sortBy: 'Frequency', sortOrder: 'desc' }]);
            const activeBoardIndex = ref(0); const newTaskData = ref({}); const currentBoard = computed(() => boards.value[activeBoardIndex.value]);
            const viewMode = ref('table'); const currentCardIdx = ref(0); const isFlipped = ref(false); const isGenerating = ref(false);
            const audioConfig = ref({ voice: 'zh-CN-XiaoxiaoNeural', rate: '-20%' }); const selectedWordIds = ref([]);
            const activeTasks = computed(() => currentBoard.value ? currentBoard.value.tasks : []);
            const isAllSelected = computed({ get: () => activeTasks.value.length > 0 && selectedWordIds.value.length === activeTasks.value.length, set: (val) => { selectedWordIds.value = val ? activeTasks.value.map(t => t.id) : []; } });
            const toggleSelectAll = () => {};
            const initForm = () => { const data = {}; currentBoard.value?.headers.forEach(h => data[h] = ''); newTaskData.value = data; };
            onMounted(() => { const saved = localStorage.getItem(STORAGE_KEY); if (saved) boards.value = JSON.parse(saved); initForm(); });
            watch(boards, (v) => localStorage.setItem(STORAGE_KEY, JSON.stringify(v)), { deep: true });
            watch(activeBoardIndex, () => { initForm(); selectedWordIds.value = []; });
            const handleFileUpload = async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); if (jsonData.length < 1) return; const headers = jsonData[0].map(h => String(h).trim()); const newTasks = jsonData.slice(1).map((row, i) => { let data = {}; headers.forEach((h, idx) => { data[h] = row[idx] !== undefined ? String(row[idx]) : ""; }); return { id: Date.now() + i, data }; }); currentBoard.value.headers = headers; currentBoard.value.tasks = newTasks; initForm(); selectedWordIds.value = []; alert('å¯¼å…¥æˆåŠŸ'); event.target.value = ''; }; reader.readAsArrayBuffer(file); };
            const exportToExcel = () => { if (!currentBoard.value) return; const headers = currentBoard.value.headers; const data = currentBoard.value.tasks.map(t => { const row = {}; headers.forEach(h => row[h] = t.data[h]); return row; }); const worksheet = XLSX.utils.json_to_sheet(data, { header: headers }); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "List"); XLSX.writeFile(workbook, `${currentBoard.value.name}.xlsx`); };
            const addTask = () => { currentBoard.value.tasks.push({ id: Date.now(), data: {...newTaskData.value} }); initForm(); };
            const updateCellValue = (task, header, e) => { task.data[header] = e.target.innerText.trim(); };
            const createNewBoard = () => { const name = prompt("Name:"); if(name) { boards.value.push({ id: Date.now(), name, headers: [...defaultHeaders], tasks: [] }); activeBoardIndex.value = boards.value.length - 1; } };
            const deletePermanent = (id) => { currentBoard.value.tasks = currentBoard.value.tasks.filter(t => t.id !== id); selectedWordIds.value = selectedWordIds.value.filter(sid => sid !== id); };
            const deleteBoard = (idx) => { if(confirm("Delete?")) boards.value.splice(idx,1); };
            const generateAudio = async () => { if (activeTasks.value.length === 0) return; isGenerating.value = true; const keyEn = currentBoard.value.headers[0]; const keyZh = currentBoard.value.headers[1]; let itemsToProcess = activeTasks.value; if (selectedWordIds.value.length > 0) { itemsToProcess = activeTasks.value.filter(t => selectedWordIds.value.includes(t.id)); } const payload = { filename: currentBoard.value.name, items: itemsToProcess.map(t => ({ English: t.data[keyEn], Chinese: t.data[keyZh] })), voice: audioConfig.value.voice, rate: audioConfig.value.rate }; try { const response = await fetch('/api/generate_audio_json', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error("Failed"); const blob = await response.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${payload.filename}.mp3`; document.body.appendChild(a); a.click(); a.remove(); } catch (e) { alert(e.message); } finally { isGenerating.value = false; } };
            return { boards, activeBoardIndex, currentBoard, newTaskData, activeTasks, viewMode, currentCardIdx, isFlipped, audioConfig, isGenerating, selectedWordIds, isAllSelected, toggleSelectAll, addTask, createNewBoard, deletePermanent, deleteBoard, updateCellValue, generateAudio, handleFileUpload, exportToExcel };
        }
    }).mount('#app');
</script>
{% endblock %}