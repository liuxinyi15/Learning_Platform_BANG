{% extends "base.html" %}

{% block title %}VOCAB MASTER{% endblock %}

{% block head %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
    /* ç¿»è½¬å¡ç‰‡ç‰¹æ•ˆ */
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
</style>
{% endblock %}

{% block content %}
{% raw %}
<div id="app" v-cloak class="max-w-[1200px] mx-auto p-6">
    
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-6 bg-white/60 p-6 rounded-2xl backdrop-blur-sm border border-white/50 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="bg-amber-100 p-3 rounded-xl text-2xl">ğŸ”¤</div>
            <div>
                <h1 class="text-3xl font-black tracking-tight text-amber-900 leading-none">VOCAB MASTER</h1>
                <p class="text-amber-800/60 font-medium mt-1 text-sm">åˆ›å»ºè¯è¡¨ã€é—ªå¡ä¸å¬åŠ›éŸ³é¢‘</p>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button @click="exportToExcel" 
                    class="bg-white text-emerald-600 border border-emerald-100 px-4 py-2.5 rounded-xl hover:bg-emerald-50 font-bold transition shadow-sm hover:shadow-md text-sm flex items-center gap-2">
                <span>ğŸ“¥ å¯¼å‡º Excel</span>
            </button>

            <button @click="viewMode = viewMode === 'table' ? 'flashcard' : 'table'" 
                    class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl hover:bg-indigo-700 font-bold transition shadow-lg text-sm flex items-center gap-2">
                <span v-if="viewMode === 'table'">ğŸ´ è¿›å…¥èƒŒè¯µæ¨¡å¼</span>
                <span v-else>ğŸ“‹ è¿”å›åˆ—è¡¨ç®¡ç†</span>
            </button>
        </div>
    </header>

    <nav class="flex gap-2 mb-6 overflow-x-auto pb-2">
        <div v-for="(board, index) in boards" :key="board.id" class="relative group flex items-center">
            <button @click="activeBoardIndex = index" 
                :class="activeBoardIndex === index ? 'bg-white text-amber-800 border-b-4 border-amber-500 shadow-sm' : 'bg-white/50 text-amber-900/50 hover:bg-white/80'" 
                class="px-6 py-3 font-bold transition-all rounded-t-xl text-sm whitespace-nowrap">
                {{ board.name }}
            </button>
            <button v-if="boards.length > 1" @click="deleteBoard(index)" class="ml-1 text-slate-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition">Ã—</button>
        </div>
        <button @click="createNewBoard" class="px-4 text-amber-700 font-bold text-xl hover:bg-white/50 rounded-lg transition">+</button>
    </nav>

    <div v-if="viewMode === 'table'" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-3 space-y-6">
            
            <div class="bg-white p-6 rounded-2xl shadow-lg shadow-amber-900/5 border border-amber-50">
                <h3 class="font-bold text-slate-400 uppercase text-[10px] tracking-widest mb-4">Add New Word</h3>
                <div class="space-y-4">
                    <div v-for="header in currentBoard.headers" :key="header">
                        <label class="block text-[11px] font-bold text-slate-500 mb-1 uppercase ml-1">{{ header }}</label>
                        <select v-if="isFrequencyField(header)" v-model="newTaskData[header]" 
                                class="w-full border border-slate-200 p-3 rounded-xl text-sm bg-slate-50 focus:ring-2 focus:ring-amber-400 outline-none">
                            <option value="High">â­â­â­ High</option>
                            <option value="Medium">â­â­ Medium</option>
                            <option value="Low">â­ Low</option>
                        </select>
                        <input v-else v-model="newTaskData[header]" :placeholder="header" 
                               class="w-full border border-slate-200 p-3 rounded-xl outline-none text-sm bg-slate-50 focus:ring-2 focus:ring-amber-400 transition">
                    </div>
                    <button @click="addTask" class="w-full bg-amber-900 text-white py-3 rounded-xl font-bold hover:bg-black transition text-sm shadow-md hover:shadow-lg transform active:scale-95 duration-200">
                        æ·»åŠ å•è¯
                    </button>
                </div>
            </div>

            <div class="bg-white/80 p-6 rounded-2xl shadow-sm border border-white/60">
                <h3 class="font-bold text-slate-400 uppercase text-[10px] tracking-widest mb-4">Import Data</h3>
                <label class="block w-full border-2 border-dashed border-slate-300 p-6 rounded-xl text-center cursor-pointer hover:border-amber-400 hover:bg-amber-50 transition group">
                    <div class="text-2xl mb-2 group-hover:scale-110 transition">ğŸ“‚</div>
                    <span class="text-xs text-amber-700 font-bold block">ä¸Šä¼  Excel / CSV</span>
                    <p class="text-[10px] text-slate-400 mt-1">æ”¯æŒ .xlsx .xls .csv</p>
                    <input type="file" @change="handleFileUpload" accept=".csv, .xlsx, .xls" class="hidden">
                </label>
            </div>

            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-xl text-white">
                <h3 class="font-bold text-white/80 uppercase text-[10px] tracking-widest mb-4 border-b border-white/20 pb-2">ğŸ§ Generate Audio</h3>
                <p class="text-xs mb-4 text-white/90 leading-relaxed">åŸºäºå‰ä¸¤åˆ—å†…å®¹ç”Ÿæˆ MP3ã€‚</p>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="text-[10px] font-bold uppercase opacity-70 block mb-1">Voice</label>
                        <select v-model="audioConfig.voice" class="w-full bg-black/20 border border-white/10 text-xs rounded-lg p-2 text-white outline-none focus:bg-black/30">
                            <option value="zh-CN-XiaoxiaoNeural" class="text-black">ğŸ‘©ğŸ» Female (Xiaoxiao)</option>
                            <option value="zh-CN-YunxiNeural" class="text-black">ğŸ‘¨ğŸ» Male (Yunxi)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase opacity-70 block mb-1">Speed</label>
                        <select v-model="audioConfig.rate" class="w-full bg-black/20 border border-white/10 text-xs rounded-lg p-2 text-white outline-none focus:bg-black/30">
                            <option value="-20%" class="text-black">Slow (-20%)</option>
                            <option value="+0%" class="text-black">Normal</option>
                            <option value="+20%" class="text-black">Fast (+20%)</option>
                        </select>
                    </div>
                </div>

<button @click="generateAudio" :disabled="isGenerating" class="w-full bg-white text-indigo-700 py-3 rounded-xl font-bold hover:bg-indigo-50 transition text-sm shadow-lg flex justify-center items-center gap-2">
    <span v-if="isGenerating">â³ ç”Ÿæˆä¸­...</span>
    <span v-else>
        <span v-if="selectedWordIds.length > 0">â–¶ï¸ ç”Ÿæˆé€‰ä¸­ ({{ selectedWordIds.length }})</span>
        <span v-else>â–¶ï¸ ç”Ÿæˆå…¨éƒ¨ ({{ activeTasks.length }})</span>
    </span>
</button>
            </div>
        </div>

        <div class="lg:col-span-9">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left border-collapse">
    <thead class="bg-amber-50/50 border-b border-amber-100 text-amber-900/50 text-[10px] uppercase font-bold">
        <tr>
            <th class="p-4 w-12 text-center">
                <input type="checkbox" v-model="isAllSelected" @change="toggleSelectAll" 
                       class="w-4 h-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
            </th>
            
            <th v-for="header in currentBoard.headers" :key="header" class="p-4 cursor-pointer hover:bg-amber-100/50 transition" @click="currentBoard.sortBy = header">
                {{ header }} <span v-if="currentBoard.sortBy === header" class="text-amber-600">â¬‡</span>
            </th>
            <th class="p-4 text-center">åˆ é™¤</th>
        </tr>
    </thead>
    <tbody class="divide-y divide-slate-50">
        <tr v-for="task in activeTasks" :key="task.id" class="hover:bg-amber-50/30 transition group"
            :class="selectedWordIds.includes(task.id) ? 'bg-amber-50/60' : ''">
            
            <td class="p-4 text-center">
                <input type="checkbox" :value="task.id" v-model="selectedWordIds" 
                       class="w-4 h-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
            </td>

            <td v-for="header in currentBoard.headers" :key="header" class="p-4 text-sm text-slate-700">
                <div v-if="isFrequencyField(header)" class="inline-block">
                    <span :class="getBadgeClass(task.data[header])" class="px-2 py-0.5 rounded text-[10px] font-bold border">
                        {{ task.data[header] }}
                    </span>
                </div>
                <div v-else class="outline-none min-h-[1.5em] border border-transparent focus:border-amber-200 focus:bg-white rounded p-1 transition" contenteditable="true" @blur="updateCellValue(task, header, $event)">
                    {{ task.data[header] }}
                </div>
            </td>
            <td class="p-4 text-center">
                <button @click="deletePermanent(task.id)" class="text-slate-300 hover:text-red-500 transition text-lg font-bold">Ã—</button>
            </td>
        </tr>
        <tr v-if="activeTasks.length === 0">
            <td :colspan="currentBoard.headers.length + 2" class="p-12 text-center text-slate-300 italic">
                åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ‰‹åŠ¨æ·»åŠ æˆ–ç‚¹å‡»å·¦ä¾§ä¸Šä¼  Excel/CSVï¼
            </td>
        </tr>
    </tbody>
</table>
                </div>
        </div>
    </div>

    <div v-else class="flex flex-col items-center justify-center min-h-[60vh] gap-8 animate-fade-in">
        <div v-if="activeTasks.length > 0" class="relative group cursor-pointer perspective-1000 w-full max-w-lg h-80" @click="isFlipped = !isFlipped">
            <div :class="['w-full h-full relative transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl', isFlipped ? 'rotate-y-180' : '']">
                
                <div class="absolute w-full h-full bg-white rounded-3xl backface-hidden flex flex-col items-center justify-center border border-slate-100">
                    <span class="text-xs text-slate-400 uppercase font-bold mb-6 tracking-widest bg-slate-50 px-3 py-1 rounded-full">
                        {{ currentBoard.headers[0] }} </span>
                    <h2 class="text-5xl font-black text-slate-800 text-center px-4 overflow-hidden text-ellipsis max-h-[60%]">
                        {{ activeTasks[currentCardIdx].data[currentBoard.headers[0]] }}
                    </h2>
                    <p class="mt-8 text-xs text-slate-300 font-bold uppercase tracking-widest animate-pulse">Click to flip</p>
                </div>

                <div class="absolute w-full h-full bg-indigo-600 rounded-3xl backface-hidden rotate-y-180 flex flex-col items-center justify-center text-white border border-indigo-500">
                    <span class="text-xs text-indigo-200 uppercase font-bold mb-6 tracking-widest bg-indigo-700/50 px-3 py-1 rounded-full">
                        {{ currentBoard.headers[1] || 'Answer' }}
                    </span>
                    <h2 class="text-4xl font-bold text-center px-4 overflow-hidden text-ellipsis max-h-[60%]">
                        {{ activeTasks[currentCardIdx].data[currentBoard.headers[1]] }}
                    </h2>
                    
                    <div v-if="currentBoard.headers[2] && activeTasks[currentCardIdx].data[currentBoard.headers[2]]" class="mt-8 px-4 py-1.5 bg-white/10 rounded-full text-xs font-bold tracking-wide">
                        {{ currentBoard.headers[2] }}: {{ activeTasks[currentCardIdx].data[currentBoard.headers[2]] }}
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTasks.length > 0" class="flex gap-6 items-center">
            <button @click="prevCard" class="bg-white w-14 h-14 rounded-full shadow-lg hover:shadow-xl hover:-translate-y-1 transition text-slate-400 flex items-center justify-center text-2xl">â¬…</button>
            <span class="font-bold text-slate-500 font-mono text-lg bg-white px-4 py-2 rounded-lg shadow-sm">{{ currentCardIdx + 1 }} / {{ activeTasks.length }}</span>
            <button @click="nextCard" class="bg-indigo-600 w-14 h-14 rounded-full shadow-lg hover:shadow-xl hover:-translate-y-1 transition text-white flex items-center justify-center text-2xl">â¡</button>
        </div>
        
        <div v-else class="text-center text-slate-400 py-10">
            <p class="mb-4">No words in this list.</p>
            <button @click="viewMode = 'table'" class="text-indigo-600 font-bold hover:underline">Go back to add words</button>
        </div>
    </div>
</div>
{% endraw %}
{% endblock %}

{% block scripts %}
<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;
    const STORAGE_KEY = 'VOCAB_MASTER_V3'; // æ›´æ–°ç‰ˆæœ¬å·

    createApp({
        setup() {
            // é»˜è®¤è¡¨å¤´
            const defaultHeaders = ['English', 'Chinese', 'Frequency'];
            const boards = ref([{ 
                id: 1, name: 'Unit 1 Vocab', headers: [...defaultHeaders], tasks: [], sortBy: 'Frequency', sortOrder: 'desc'
            }]);
            
            const activeBoardIndex = ref(0);
            const newTaskData = ref({});
            const currentBoard = computed(() => boards.value[activeBoardIndex.value]);
            const viewMode = ref('table'); 
            const currentCardIdx = ref(0);
            const isFlipped = ref(false);
            const isGenerating = ref(false);
            const audioConfig = ref({ voice: 'zh-CN-XiaoxiaoNeural', rate: '-20%' });

            // ğŸ”¥ æ–°å¢ï¼šé€‰ä¸­çš„å•è¯IDæ•°ç»„
            const selectedWordIds = ref([]);

            const activeTasks = computed(() => {
                if (!currentBoard.value) return [];
                return currentBoard.value.tasks;
            });

            // ğŸ”¥ æ–°å¢ï¼šå…¨é€‰çŠ¶æ€è®¡ç®—å±æ€§
            const isAllSelected = computed({
                get: () => activeTasks.value.length > 0 && selectedWordIds.value.length === activeTasks.value.length,
                set: (val) => {
                    if (val) {
                        selectedWordIds.value = activeTasks.value.map(t => t.id);
                    } else {
                        selectedWordIds.value = [];
                    }
                }
            });

            // ğŸ”¥ æ–°å¢ï¼šå…¨é€‰åˆ‡æ¢å‡½æ•° (ç”¨äº checkbox @change)
            const toggleSelectAll = () => {
                // é€»è¾‘å·²åœ¨ computed set ä¸­å¤„ç†ï¼Œè¿™é‡Œåªéœ€å ä½æˆ–åšé¢å¤–é€»è¾‘
            };

            const initForm = () => {
                const data = {};
                currentBoard.value?.headers.forEach(h => {
                    data[h] = isFrequencyField(h) ? 'Medium' : '';
                });
                newTaskData.value = data;
            };

            onMounted(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) boards.value = JSON.parse(saved);
                initForm();
            });

            watch(boards, (v) => localStorage.setItem(STORAGE_KEY, JSON.stringify(v)), { deep: true });
            
            // åˆ‡æ¢åˆ—è¡¨æ—¶æ¸…ç©ºé€‰æ‹©
            watch(activeBoardIndex, () => {
                initForm();
                currentCardIdx.value = 0;
                isFlipped.value = false;
                selectedWordIds.value = []; // æ¸…ç©ºé€‰ä¸­
            });

            const isFrequencyField = (h) => {
                const s = String(h).toLowerCase();
                return s.includes('frequency') || s.includes('importance') || s.includes('level') || s.includes('é¢‘ç‡') || s.includes('é‡è¦æ€§');
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (jsonData.length < 1) { alert("æ–‡ä»¶ä¸ºç©ºï¼"); return; }
                    const headers = jsonData[0].map(h => String(h).trim());
                    const newTasks = jsonData.slice(1).map((row, i) => {
                        let data = {};
                        headers.forEach((h, idx) => { data[h] = row[idx] !== undefined ? String(row[idx]) : ""; });
                        return { id: Date.now() + i, data };
                    });
                    currentBoard.value.headers = headers;
                    currentBoard.value.tasks = newTasks;
                    initForm(); 
                    selectedWordIds.value = []; // å¯¼å…¥æ–°æ•°æ®åæ¸…ç©ºé€‰ä¸­
                    alert(`æˆåŠŸå¯¼å…¥ ${newTasks.length} ä¸ªæ¡ç›®ï¼`);
                    event.target.value = ''; 
                };
                reader.readAsArrayBuffer(file);
            };

            const exportToExcel = () => {
                if (!currentBoard.value || currentBoard.value.tasks.length === 0) return alert("åˆ—è¡¨ä¸ºç©º");
                const headers = currentBoard.value.headers;
                const data = currentBoard.value.tasks.map(t => {
                    const row = {};
                    headers.forEach(h => row[h] = t.data[h]);
                    return row;
                });
                const worksheet = XLSX.utils.json_to_sheet(data, { header: headers });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Vocab List");
                XLSX.writeFile(workbook, `${currentBoard.value.name}.xlsx`);
            };

            const addTask = () => {
                const firstHeader = currentBoard.value.headers[0];
                if(!newTaskData.value[firstHeader]) return alert(`${firstHeader} is required`);
                currentBoard.value.tasks.push({ id: Date.now(), data: {...newTaskData.value} });
                initForm();
            };

            const updateCellValue = (task, header, e) => { task.data[header] = e.target.innerText.trim(); };
            
            const createNewBoard = () => {
                const name = prompt("New List Name:");
                if(name) { 
                    boards.value.push({ id: Date.now(), name, headers: [...defaultHeaders], tasks: [], sortBy: 'Frequency', sortOrder: 'desc' }); 
                    activeBoardIndex.value = boards.value.length - 1; 
                }
            };

            const deletePermanent = (id) => { 
                currentBoard.value.tasks = currentBoard.value.tasks.filter(t => t.id !== id); 
                selectedWordIds.value = selectedWordIds.value.filter(sid => sid !== id); // åŒæ—¶ä»é€‰ä¸­åˆ—è¡¨ä¸­ç§»é™¤
            };
            const deleteBoard = (idx) => { if(confirm("Delete this list?")) boards.value.splice(idx,1); }
            
            const getBadgeClass = (v) => {
                const s = String(v).toLowerCase();
                if(s.includes('high') || s.includes('3') || s.includes('é«˜')) return 'bg-red-50 text-red-600 border-red-200';
                if(s.includes('medium') || s.includes('2') || s.includes('ä¸­')) return 'bg-orange-50 text-orange-600 border-orange-200';
                return 'bg-green-50 text-green-600 border-green-200';
            };

            const nextCard = () => { isFlipped.value = false; setTimeout(() => { if (currentCardIdx.value < activeTasks.value.length - 1) currentCardIdx.value++; else currentCardIdx.value = 0; }, 200); };
            const prevCard = () => { isFlipped.value = false; setTimeout(() => { if (currentCardIdx.value > 0) currentCardIdx.value--; else currentCardIdx.value = activeTasks.value.length - 1; }, 200); };

            // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šç”ŸæˆéŸ³é¢‘é€»è¾‘
            const generateAudio = async () => {
                if (activeTasks.value.length === 0) return alert("åˆ—è¡¨ä¸ºç©ºï¼");
                isGenerating.value = true;
                
                const keyEn = currentBoard.value.headers[0];
                const keyZh = currentBoard.value.headers[1];

                // ğŸ”¥ ç­›é€‰é€»è¾‘ï¼šå¦‚æœé€‰ä¸­äº†ï¼Œåªç”Ÿæˆé€‰ä¸­çš„ï¼›å¦åˆ™ç”Ÿæˆå…¨éƒ¨
                let itemsToProcess = activeTasks.value;
                if (selectedWordIds.value.length > 0) {
                    itemsToProcess = activeTasks.value.filter(t => selectedWordIds.value.includes(t.id));
                }

                const payload = {
                    filename: currentBoard.value.name + (selectedWordIds.value.length > 0 ? "_Selected" : ""), // æ–‡ä»¶ååŠ åç¼€
                    items: itemsToProcess.map(t => ({
                        English: t.data[keyEn], 
                        Chinese: t.data[keyZh] 
                    })),
                    voice: audioConfig.value.voice,
                    rate: audioConfig.value.rate
                };
                try {
                    const response = await fetch('/api/generate_audio_json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error("Generation failed");
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${payload.filename}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } catch (e) {
                    alert("Error generating audio: " + e.message);
                } finally {
                    isGenerating.value = false;
                }
            };

            return { 
                boards, activeBoardIndex, currentBoard, newTaskData, activeTasks, 
                viewMode, currentCardIdx, isFlipped, audioConfig, isGenerating,
                selectedWordIds, isAllSelected, toggleSelectAll, // è®°å¾—å¯¼å‡ºè¿™å‡ ä¸ªæ–°å˜é‡
                addTask, createNewBoard, deletePermanent, deleteBoard,
                updateCellValue, getBadgeClass, nextCard, prevCard, generateAudio,
                handleFileUpload, exportToExcel, isFrequencyField
            };
        }
    }).mount('#app');
</script>
{% endblock %}