{% extends "base.html" %}
{% block title %}Smart Grading{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<style>
    .file-drop-zone { border: 2px dashed #94a3b8; background-color: #f8fafc; transition: all 0.3s; }
    .file-drop-zone:hover, .file-drop-zone.active { border-color: #0891b2; background-color: #ecfeff; }
    .btn-cyan { background-color: #0e7490; color: white; transition: all 0.2s; }
    .btn-cyan:hover { background-color: #155e75; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(8, 145, 178, 0.3); }
    .btn-cyan:disabled { background-color: #cbd5e1; cursor: not-allowed; color: #94a3b8; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-[1200px] mx-auto p-6 fade-in-up">
    <header class="mb-10 bg-white p-8 rounded-3xl border border-slate-100 shadow-sm relative overflow-hidden text-center">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-cyan-600 to-slate-600"></div>
        <div class="absolute -left-10 -bottom-20 w-40 h-40 bg-cyan-50 rounded-full blur-3xl opacity-60"></div>
        <div class="relative z-10">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-cyan-50 text-cyan-800 rounded-2xl text-3xl mb-4 shadow-sm border border-cyan-100">üìù</div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">Smart Grading System</h1>
            <p class="text-slate-500 mt-2 text-sm font-medium bg-slate-50 inline-block px-4 py-1 rounded-full border border-slate-100">Upload Answer Sheets & Question Bank ¬∑ Auto Scoring</p>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-5 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-500 uppercase text-xs tracking-widest mb-6 flex items-center gap-2">
                    <span class="bg-cyan-100 text-cyan-800 w-6 h-6 rounded-full flex items-center justify-center text-[10px]">1</span> Upload Data Sources
                </h3>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-2">Student Answer Sheet (Excel)</label>
                    <div class="file-drop-zone p-4 rounded-xl text-center cursor-pointer relative group">
                        <input type="file" id="file_stu" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="updateFileLabel('stu', this)">
                        <div id="label_stu" class="text-slate-400 text-sm py-2">üìä Click to upload answer sheet</div>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-2">Comprehensive Question Bank (Excel)</label>
                    <div class="file-drop-zone p-4 rounded-xl text-center cursor-pointer relative group">
                        <input type="file" id="file_bank" accept=".xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="updateFileLabel('bank', this)">
                        <div id="label_bank" class="text-slate-400 text-sm py-2">üìö Click to upload question bank</div>
                    </div>
                </div>
                <button onclick="uploadFiles()" id="uploadBtn" class="w-full btn-cyan py-3 rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2">‚ö° Start Analysis</button>
            </div>
            <div class="bg-gradient-to-br from-cyan-700 to-slate-700 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="font-bold text-lg mb-1">Class Result Summary</h3>
                    <p class="text-cyan-100 text-xs mb-4" id="summaryStatus">Awaiting analysis...</p>
                    <button onclick="downloadAllScores()" id="downloadAllBtn" disabled class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-bold backdrop-blur-sm transition disabled:opacity-50 border border-white/20">üì• Export Scoresheet</button>
                </div>
                <div class="absolute -right-6 -bottom-6 text-9xl text-white/5 rotate-12">üèÜ</div>
            </div>
        </div>

        <div class="lg:col-span-7 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-4">Error Distribution Overview</h3>
                <div class="w-full h-[300px] flex items-center justify-center bg-slate-50 rounded-xl border border-dashed border-slate-200" id="chartContainer"><span class="text-slate-300 text-sm">No data</span></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-4">Individual Error Details</h3>
                <div class="flex gap-4 mb-6">
                    <select id="studentSelect" class="flex-1 p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none text-sm" onchange="loadStudentErrors()">
                        <option value="">-- Select Student --</option>
                    </select>
                    <div class="px-6 py-2 bg-slate-100 text-slate-700 rounded-xl border border-slate-200 flex flex-col items-center justify-center min-w-[100px]">
                        <span class="text-[10px] text-slate-400 uppercase font-bold">SCORE</span><strong class="text-xl" id="scoreVal">--</strong>
                    </div>
                </div>
                <div id="resultArea" style="display:none;" class="animate-fade-in-up">
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100 mb-4">
                        <h6 class="text-xs font-bold text-red-500 uppercase mb-2">Wrong Questions</h6><div id="wrongIds" class="flex flex-wrap gap-2"></div>
                    </div>
                    <button onclick="downloadExcel()" class="w-full py-3 bg-white border-2 border-cyan-100 text-cyan-700 font-bold rounded-xl hover:bg-cyan-50">üìÑ Download Personal Error Book</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let errorChart = null;
    function updateFileLabel(type, input) { if (input.files && input.files.length > 0) { document.getElementById(`label_${type}`).innerHTML = `<span class="text-cyan-700 font-bold">üìÑ ${input.files[0].name}</span>`; input.parentElement.classList.add('border-cyan-400', 'bg-cyan-50'); } }
    async function uploadFiles() { 
        const fileStu = document.getElementById('file_stu').files[0]; 
        const fileBank = document.getElementById('file_bank').files[0]; 
        if (!fileStu || !fileBank) return alert("Please upload both files!"); 
        const btn = document.getElementById('uploadBtn'); btn.disabled = true; btn.innerText = "Analyzing..."; 
        const formData = new FormData(); formData.append('student_ans', fileStu); formData.append('combined_bank', fileBank); 
        try { 
            const res = await fetch('/api/correction/upload', { method: 'POST', body: formData }); 
            const data = await res.json(); 
            if (data.error) throw new Error(data.error); 
            const select = document.getElementById('studentSelect'); select.innerHTML = '<option value="">-- Choose Student --</option>'; 
            data.students.forEach(name => select.add(new Option(name, name))); 
            document.getElementById('downloadAllBtn').disabled = false; 
            document.getElementById('summaryStatus').innerHTML = `‚úÖ Complete | Total Score: ${data.paper_total}`; 
            renderChart(data.question_error_counts); 
        } catch (e) { alert(e.message); } finally { btn.disabled = false; btn.innerText = "‚ö° Re-analyze"; } 
    }
    function renderChart(errorCounts) { 
        const container = document.getElementById('chartContainer'); container.innerHTML = '<canvas id="errorChart"></canvas>'; 
        const ctx = document.getElementById('errorChart').getContext('2d'); 
        if (errorChart) errorChart.destroy(); 
        errorChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(errorCounts), datasets: [{ label: 'Error Count', data: Object.values(errorCounts), backgroundColor: 'rgba(8, 145, 178, 0.6)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); 
    }
    async function loadStudentErrors() { 
        const name = document.getElementById('studentSelect').value; if (!name) return; 
        const res = await fetch(`/api/correction/get_student/${encodeURIComponent(name)}`); 
        const data = await res.json(); 
        document.getElementById('scoreVal').innerText = `${data.total_score} / ${data.paper_total}`; 
        const container = document.getElementById('wrongIds'); container.innerHTML = ''; 
        if (data.wrong_questions.length > 0) { data.wrong_questions.forEach(q => { const s = document.createElement('span'); s.className = 'px-2 py-1 bg-white border border-red-200 text-red-500 rounded text-xs font-bold'; s.innerText = q; container.appendChild(s); }); } 
        else { container.innerHTML = '<span class="text-emerald-500 font-bold">üéâ Perfect Score!</span>'; } 
        document.getElementById('resultArea').style.display = 'block'; 
    }
    function downloadExcel() { const name = document.getElementById('studentSelect').value; if(name) window.location.href = `/api/correction/download/student/${encodeURIComponent(name)}`; }
    function downloadAllScores() { window.location.href = `/api/correction/download/all`; }
</script>
{% endblock %}